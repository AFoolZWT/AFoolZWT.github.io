<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>ECS学习笔记（2） | 愚人のblog</title><meta name="keywords" content="Unity,ECS"><meta name="author" content="愚人"><meta name="copyright" content="愚人"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="IInitializeSystem从这章这开始我们以一个小案例分章介绍Entitas为我们提供的五种类型的System。案例的主要功能比较简单，大致的流程如下：  在游戏启动时在屏幕上创建一个站立的小熊。 点击键盘上的左右按键时将小熊切换成一个对应方向的Sprite，朝对应方向移动并实时打印位置信息。松开左右按键时切换回站立的小熊Sprite，结束打印位置信息。 结束游戏输出一个”Game Ove">
<meta property="og:type" content="article">
<meta property="og:title" content="ECS学习笔记（2）">
<meta property="og:url" content="https://afoolzwt.github.io/2022/02/07/ECS2/index.html">
<meta property="og:site_name" content="愚人のblog">
<meta property="og:description" content="IInitializeSystem从这章这开始我们以一个小案例分章介绍Entitas为我们提供的五种类型的System。案例的主要功能比较简单，大致的流程如下：  在游戏启动时在屏幕上创建一个站立的小熊。 点击键盘上的左右按键时将小熊切换成一个对应方向的Sprite，朝对应方向移动并实时打印位置信息。松开左右按键时切换回站立的小熊Sprite，结束打印位置信息。 结束游戏输出一个”Game Ove">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://afoolzwt.github.io/img/cover2.jpg">
<meta property="article:published_time" content="2022-02-06T16:00:00.000Z">
<meta property="article:modified_time" content="2022-02-07T05:34:02.938Z">
<meta property="article:author" content="愚人">
<meta property="article:tag" content="Unity">
<meta property="article:tag" content="ECS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://afoolzwt.github.io/img/cover2.jpg"><link rel="shortcut icon" href="/img/webicon.png"><link rel="canonical" href="https://afoolzwt.github.io/2022/02/07/ECS2/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="baidu-site-verification" content="&lt;meta name=&quot;baidu-site-verification&quot; content=&quot;code-HqA81hlzlz&quot; /&gt;"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ECS学习笔记（2）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-02-07 13:34:02'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="愚人のblog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/headicon.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">55</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">44</div></a></div></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: lightblue"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">愚人のblog</a></span><div id="menus"><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ECS学习笔记（2）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-02-06T16:00:00.000Z" title="发表于 2022-02-07 00:00:00">2022-02-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-02-07T05:34:02.938Z" title="更新于 2022-02-07 13:34:02">2022-02-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Unity/">Unity</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Unity/ECS/">ECS</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ECS学习笔记（2）"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="IInitializeSystem"><a href="#IInitializeSystem" class="headerlink" title="IInitializeSystem"></a>IInitializeSystem</h1><p>从这章这开始我们以一个小案例分章介绍Entitas为我们提供的五种类型的System。<br>案例的主要功能比较简单，大致的流程如下：</p>
<ul>
<li>在游戏启动时在屏幕上创建一个站立的小熊。</li>
<li>点击键盘上的左右按键时将小熊切换成一个对应方向的Sprite，朝对应方向移动并实时打印位置信息。松开左右按键时切换回站立的小熊Sprite，结束打印位置信息。</li>
<li>结束游戏输出一个”Game Over!”信息。<br>这一章我们将在游戏中通过代码创建一个小熊的GameObject,并可以看到小熊Entity的一些组件信息。<h2 id="案例准备"><a href="#案例准备" class="headerlink" title="案例准备"></a>案例准备</h2><h3 id="创建ViewComponent-cs"><a href="#创建ViewComponent-cs" class="headerlink" title="创建ViewComponent.cs"></a>创建ViewComponent.cs</h3></li>
<li>ViewComponent 记录小熊的GameObject</li>
<li>SpriteComponent 记录小熊的Sprite名称数据</li>
<li>PositionComponent 记录小熊的Position数据</li>
<li>DirectionComponent 记录小熊的方向数据</li>
<li>MoveSpeedComponent 记录小熊的移动速度数据 （但是这里需要注意，这个组件一旦添加到小熊身上就会移动，不需要移动时需将这个组件移除，这就是我们将Component时提到过的通过修改组件来改变Entity的行为）<br>多个组件可以放在一个文件中可以分成多个文件，我们这里就放在一个文件中 ViewComponent.cs。<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Entitas;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> View组件</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Game</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ViewComponent</span> : <span class="title">IComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> GameObject gameObject;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Sprite组件</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Game</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SpriteComponent</span> : <span class="title">IComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> <span class="keyword">value</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Position组件</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Game</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PositionComponent</span> : <span class="title">IComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Vector2 <span class="keyword">value</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MoveSpeed组件</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Game</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MoveSpeedComponent</span> : <span class="title">IComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> <span class="keyword">value</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Direction组件</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Game</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DirectionComponent</span> : <span class="title">IComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 表示站立，向左，向右三种朝向状态</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> EDirection</span><br><span class="line">    &#123;</span><br><span class="line">        stand,</span><br><span class="line">        left,</span><br><span class="line">        right,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> EDirection <span class="keyword">value</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><em>注意：每次添加新的组件代码之后需要重新生成一下代码才会被Entitas引用。</em>*</li>
</ul>
<h3 id="创建AddSystem-cs-IInitializeSystem"><a href="#创建AddSystem-cs-IInitializeSystem" class="headerlink" title="创建AddSystem.cs     IInitializeSystem"></a>创建AddSystem.cs     IInitializeSystem</h3><p>我们全局只需要一个小熊实体，并在游戏开始时就创建出来，所以需要继承IInitializeSystem这个接口，并实现Initialize()方法用来执行创建小熊的逻辑。<br>这个接口和MonoBehaviour生命周期中的Start()方法类似。但是和MonoBehaviour不同的是如果我们有多个继承自IInitializeSystem接口的System，执行顺序是先添加到Systems中的先执行。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Entitas;</span><br><span class="line"><span class="keyword">using</span> Entitas.Unity;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AddViewSystem</span> : <span class="title">IInitializeSystem</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//创建一个小熊容器</span></span><br><span class="line">    <span class="keyword">readonly</span> Transform gameContainer = <span class="keyword">new</span> GameObject(<span class="string">&quot;Game Container&quot;</span>).transform;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//需要处理的Component都是属于GameContext,所以我们需要从Contexts中拿到Game Context.</span></span><br><span class="line">    <span class="keyword">readonly</span> GameContext _context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AddViewSystem</span>(<span class="params">Contexts contexts</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _context = contexts.game;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Initialize</span>(<span class="params"></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> entity = _context.CreateEntity();</span><br><span class="line">        GameObject go = <span class="keyword">new</span> GameObject(<span class="string">&quot;Game Entity&quot;</span>);</span><br><span class="line">        go.transform.SetParent(gameContainer,<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加ViewComponent并为ViewComponent的gameObject赋值</span></span><br><span class="line">        entity.AddView(go);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加PositionComponent并为PositionComponent的value字段赋值</span></span><br><span class="line">        entity.AddPosition(Vector2.zero);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加SpriteComponent并为SpriteComponent的value字段赋值</span></span><br><span class="line">        entity.AddSprite(<span class="string">&quot;monkey_stand&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加DirectionComponent并为DirectionComponent的value字段赋值</span></span><br><span class="line">        entity.AddDirection(DirectionComponent.EDirection.stand);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将Entity链接到GameObject上</span></span><br><span class="line">        go.Link(entity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="拓展：C-中的readonly"><a href="#拓展：C-中的readonly" class="headerlink" title="拓展：C#中的readonly"></a>拓展：C#中的readonly</h4><p>顾名思义，只读字段，就是说在程序运转过程中，程序中能够读取这个字段的值，而不能修正它的值。在C#中能够运用readonly关键词来解说一个只读字段。<br>在C#中运用只读字段主要有以下几个关键：<br>　　（1）只读字段能够在解说的一起赋值或者在类的结构办法中给其赋值；<br>　　（2）除了结构办法外，其他地方不能够修正只读字段的值；<br>　　（3）只读字段的特点只能有get访问器，不能有set，这是显而易见的；<br>只读字段与常量的区别：<br>　　常量（运用const关键字解说）只能在声明的一起初始化（赋值）。<br>　　readonly字段能够在声明或结构函数中初始化。因而，依据所运用的结构函数，readonly字段可能具有不同的值。</p>
<h3 id="GameSystems-cs"><a href="#GameSystems-cs" class="headerlink" title="GameSystems.cs"></a>GameSystems.cs</h3><p>我们还需要一个用来管理System的Systems。并将刚才创建的AddSystem.cs添加到Systems中。<br>我们为了能在Unity编辑器中看到System的信息，所以GameSystems继承自Feature。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Entitas;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameSystems</span> : <span class="title">Feature</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GameSystems</span>(<span class="params">Contexts contexts</span>) : <span class="title">base</span>(<span class="params"><span class="string">&quot;Game Systems&quot;</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* -- Init System -- */</span></span><br><span class="line">        Add(<span class="keyword">new</span> AddViewSystem(contexts));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="GameController-cs"><a href="#GameController-cs" class="headerlink" title="GameController.cs"></a>GameController.cs</h3><p>我们写了这么多代码但是Unity开始运行的时候并不会执行啊，所以我们还需要有一个继承自MonoBehaviour的脚本来负责创建，初始化和执行各个System。<br>我们就叫GameController.cs吧。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Entitas;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameController</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    Systems _systems;</span><br><span class="line">    Contexts _contexts;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _contexts = Contexts.sharedInstance;</span><br><span class="line">        _systems = <span class="keyword">new</span> GameSystems(_contexts);</span><br><span class="line"></span><br><span class="line">        _systems.Initialize();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>点击运行后，我们可以在Hierarchy面板中看到这些东西。<br><img src="/img/ECS/3.png" alt="3.png"></li>
<li>选中Hierarchy面板中Game然后可以在Inspector面板中看到这些信息。<br>![4.png]/img/ECS/4.png)<br>这里列出来了当前活动的Entity和被回收的Entity数量，创建Entity和回收所有Entity的按钮。</li>
<li>Game下的Entity_0然后可以在Inspector面板中看到这些信息。<br><img src="/img/ECS/5.png" alt="5.png"><br>其中包含了刚才我们在AddViewSystem中为其实体添加的组件信息和数据信息。</li>
<li>最后选中Hierarchy面板中Game Systems然后可以在Inspector面板中看到这些信息了。<br><img src="/img/ECS/6.png" alt="6.png"><br>可以看到每种类型的System列表,System的性能开销。这里会每帧动态刷新。<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1></li>
<li><em>IInitializeSystem 会在游戏开始之前执行一次。在这里设置初始游戏状态，类似于Unity的Start()方法。创建游戏中的全局实体（例如，用于访问配置数据）</em>*</li>
</ul>
<hr>
<h1 id="ReactiveSystem＜Entity＞"><a href="#ReactiveSystem＜Entity＞" class="headerlink" title="ReactiveSystem＜Entity＞"></a>ReactiveSystem＜Entity＞</h1><p>这一章我们通过ReactiveSystem系统将Entity上组件的数据和GameObject联系起来。</p>
<h2 id="ReactiveSystem"><a href="#ReactiveSystem" class="headerlink" title="ReactiveSystem"></a>ReactiveSystem</h2><p>ReactiveSystem和其他System不同的是它继承类而不是实现接口。<br>Entitas为每个Context生成Entity类型，例如GameEntity,InputEntity。<br>ReactiveSystem只对指定的Entity类型产生响应。<br>但是同一种类型的Entity还是有很多，我们并不希望处理每一个，而是处理某些Component发生变化的Entity。<br>所以ReactiveSystem必须重写三个方法GetTrigger(),Filter(),Execute()。</p>
<ul>
<li>GetTrigger() 返回一个ICollector对象用来收集ReactiveSystem需要处理的那一部分Entity</li>
<li>Filter() 对ICollector返回的实体进行再一次检查确保被Execute()方法处理前已经添加了需要的Component。</li>
<li>Execute() 需要对Entity执行的逻辑<h2 id="RenderSpriteSystem-cs-ReactiveSystem"><a href="#RenderSpriteSystem-cs-ReactiveSystem" class="headerlink" title="RenderSpriteSystem.cs        ReactiveSystem"></a>RenderSpriteSystem.cs        ReactiveSystem</h2>首先需要将SpriteComponent组件上图片名称赋值给SpriteRenderer。<br>要实现这个功能我们使用IInitializeSystem系统也可以实现，但是之后我们还需要在按下键盘上左右键的时候切换图片，所以需要ReactiveSystem系。<br>RenderSpriteSystem将收集那些SpriteComponent发生变化的Entity,将图片赋值到SpriteRenderer。<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Entitas;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> RenderSpriteSystem</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RenderSpriteSystem</span> : <span class="title">ReactiveSystem</span>&lt;<span class="title">GameEntity</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RenderSpriteSystem</span>(<span class="params">Contexts contexts</span>) : <span class="title">base</span>(<span class="params">contexts.game</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Execute</span>(<span class="params">List&lt;GameEntity&gt; entities</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> entities)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//为每个符合条件的Entity的SpriteRender赋值</span></span><br><span class="line">            SpriteRenderer sr = item.view.gameObject.GetComponent&lt;SpriteRenderer&gt;();</span><br><span class="line">            <span class="keyword">if</span> (sr == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                sr = item.view.gameObject.AddComponent&lt;SpriteRenderer&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            sr.sprite = Resources.Load&lt;Sprite&gt;(item.sprite.<span class="keyword">value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">Filter</span>(<span class="params">GameEntity entity</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//确定Entity是否有SpriteComponent和ViewComponent</span></span><br><span class="line">        <span class="keyword">return</span> entity.hasSprite &amp;&amp; entity.hasView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> ICollector&lt;GameEntity&gt; <span class="title">GetTrigger</span>(<span class="params">IContext&lt;GameEntity&gt; context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 创建一个ICollector用来收集所有SpriteComponent变化的GameEntity</span></span><br><span class="line">        <span class="keyword">return</span> context.CreateCollector(GameMatcher.Sprite);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="RenderPositionSystem-cs-ReactiveSystem"><a href="#RenderPositionSystem-cs-ReactiveSystem" class="headerlink" title="RenderPositionSystem.cs        ReactiveSystem"></a>RenderPositionSystem.cs        ReactiveSystem</h2><p>还需要一个RenderPositionSystem用来为那些PositionComponent发生变化的Entity刷新位置。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Entitas;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> RenderPositionSystem</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RenderPositionSystem</span> : <span class="title">ReactiveSystem</span>&lt;<span class="title">GameEntity</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">readonly</span> GameContext _context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RenderPositionSystem</span>(<span class="params">Contexts contexts</span>) : <span class="title">base</span>(<span class="params">contexts.game</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _context = contexts.game;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Execute</span>(<span class="params">List&lt;GameEntity&gt; entities</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> entities)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//为每个符合条件的Entity刷新位置</span></span><br><span class="line">            item.view.gameObject.transform.position = item.position.<span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">Filter</span>(<span class="params">GameEntity entity</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//确定Entity是否有PositionComponent和ViewComponent</span></span><br><span class="line">        <span class="keyword">return</span> entity.hasPosition &amp;&amp; entity.hasView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> ICollector&lt;GameEntity&gt; <span class="title">GetTrigger</span>(<span class="params">IContext&lt;GameEntity&gt; context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//创建一个ICollector用来收集所有PositionComponent变化的GameEntity</span></span><br><span class="line">        <span class="keyword">return</span> context.CreateCollector(GameMatcher.Position);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="RenderDirectionSystem-cs-ReactiveSystem"><a href="#RenderDirectionSystem-cs-ReactiveSystem" class="headerlink" title="RenderDirectionSystem.cs            ReactiveSystem"></a>RenderDirectionSystem.cs            ReactiveSystem</h2><p>最后还需要一个用来处理DirectionComponent的System，逻辑和上面的基本相同。<br>只是在逻辑执行时,因为我们让小熊转向就是将小熊的图片切换成对应朝向的图片的逻辑。<br>所以RenderDirectionSystem就是根据DirectionComponent的数据切换SpriteComponent的数据。<br>然后就交由RenderSpriteSystem来处理图片切换的逻辑了。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Entitas;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> RenderDirectionSystem</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RenderDirectionSystem</span> : <span class="title">ReactiveSystem</span>&lt;<span class="title">GameEntity</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RenderDirectionSystem</span>(<span class="params">Contexts contexts</span>) : <span class="title">base</span>(<span class="params">contexts.game</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Execute</span>(<span class="params">List&lt;GameEntity&gt; entities</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> entities)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//为每个符合条件的Entity改变SpriteComponent数据</span></span><br><span class="line">            <span class="built_in">string</span> spriteName = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">switch</span> (item.direction.<span class="keyword">value</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> DirectionComponent.EDirection.stand:</span><br><span class="line">                    spriteName = <span class="string">&quot;monkey_stand&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> DirectionComponent.EDirection.left:</span><br><span class="line">                    spriteName = <span class="string">&quot;monkey_left&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> DirectionComponent.EDirection.right:</span><br><span class="line">                    spriteName = <span class="string">&quot;monkey_right&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="literal">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (item.sprite.<span class="keyword">value</span> != spriteName)</span><br><span class="line">            &#123;</span><br><span class="line">                item.ReplaceSprite(spriteName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">Filter</span>(<span class="params">GameEntity entity</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//确定Entity是否有DirectionComponent和ViewComponent</span></span><br><span class="line">        <span class="keyword">return</span> entity.hasDirection &amp;&amp; entity.hasView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> ICollector&lt;GameEntity&gt; <span class="title">GetTrigger</span>(<span class="params">IContext&lt;GameEntity&gt; context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//创建一个ICollector用来收集所有DirectionComponent变化的GameEntity</span></span><br><span class="line">        <span class="keyword">return</span> context.CreateCollector(GameMatcher.Direction);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后不要忘了将我们新创建的三个系统添加到GameSystems中，并在GameController的Update()方法中每帧执行我们的系统</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Entitas;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameSystems</span> : <span class="title">Feature</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GameSystems</span>(<span class="params">Contexts contexts</span>) : <span class="title">base</span>(<span class="params"><span class="string">&quot;Game Systems&quot;</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* -- Init System -- */</span></span><br><span class="line">        Add(<span class="keyword">new</span> AddViewSystem(contexts));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* -- Execute System -- */</span></span><br><span class="line">        Add(<span class="keyword">new</span> RenderPositionSystem(contexts));</span><br><span class="line">        Add(<span class="keyword">new</span> RenderDirectionSystem(contexts));</span><br><span class="line">        Add(<span class="keyword">new</span> RenderSpriteSystem(contexts));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在在编辑器中运行一下就可以在Game视图中看到我们的人物<br><img src="/img/ECS/7.png" alt="7.png"><br>但是现在按键盘上任何按键人物还不会有反应，但是我们可以在Hierarchy面板中选中这个Entity。<br>然后调整DirectionComponent和PositionComponent的数值就可以看到人物会有响应了。<br><img src="/img/ECS/8.png" alt="8.png"></p>
<h1 id="总结：-ReactiveSystem就是实时收集一些自己感兴趣的组件发生变化的Entity，并执行相应的逻辑。"><a href="#总结：-ReactiveSystem就是实时收集一些自己感兴趣的组件发生变化的Entity，并执行相应的逻辑。" class="headerlink" title="总结： ReactiveSystem就是实时收集一些自己感兴趣的组件发生变化的Entity，并执行相应的逻辑。"></a>总结： ReactiveSystem就是实时收集一些自己感兴趣的组件发生变化的Entity，并执行相应的逻辑。</h1><hr>
<h1 id="IExecuteSystem"><a href="#IExecuteSystem" class="headerlink" title="IExecuteSystem"></a>IExecuteSystem</h1><p>这个系统也比较简单，和IInitializeSystem很相似，区别就是IInitializeSystem是游戏开始时执行一次Initialize()方法，IExecuteSystem时每帧执行一次Execute()方法。<br>类似与MonoBehaviour生命周期中的Update()方法。</p>
<h2 id="ArrowStateComponent-cs"><a href="#ArrowStateComponent-cs" class="headerlink" title="ArrowStateComponent.cs"></a>ArrowStateComponent.cs</h2><p>这里我们主要是想收集键盘的输入信息，所以我们和之前Game Context分开，在Input Context下创建两个分别记录左键和右键状态的组件，同时左键和右键的状态组件不需要多个所以我们[Unique]属性让组件成为单例。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Entitas;</span><br><span class="line"><span class="keyword">using</span> Entitas.CodeGeneration.Attributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> EArrowState</span><br><span class="line">&#123;</span><br><span class="line">    None,</span><br><span class="line">    Down,</span><br><span class="line">    Up,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> LeftArrowStateComponent</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Input</span>]</span><br><span class="line">[<span class="meta">Unique</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LeftArrowStateComponent</span> : <span class="title">IComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> EArrowState state;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> RightArrowStateComponent</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Input</span>]</span><br><span class="line">[<span class="meta">Unique</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RightArrowStateComponent</span> : <span class="title">IComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> EArrowState state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="InputDeviceSystem-cs-IInitializeSystem-IExecuteSystem"><a href="#InputDeviceSystem-cs-IInitializeSystem-IExecuteSystem" class="headerlink" title="InputDeviceSystem.cs            IInitializeSystem,IExecuteSystem"></a>InputDeviceSystem.cs            IInitializeSystem,IExecuteSystem</h2><p>注意:<br>InputDeviceSystem.cs 同时实现IInitializeSystem,IExecuteSystem两个接口，需要在IInitializeSystem接口的Initialize()方法中初始化LeftArrowStateComponent，RightArrowStateComponent两个组件。<br>然后在IExecuteSystem接口的Execute()方法中检测是否按下键盘的左右键。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Entitas;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> InputDeviceSystem</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InputDeviceSystem</span> : <span class="title">IInitializeSystem</span>,<span class="title">IExecuteSystem</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">readonly</span> InputContext _context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InputDeviceSystem</span>(<span class="params">Contexts contexts</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _context = contexts.input;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Initialize</span>(<span class="params"></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _context.SetLeftArrowState(EArrowState.None);</span><br><span class="line">        _context.SetRightArrowState(EArrowState.None);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Execute</span>(<span class="params"></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Input.GetKey(KeyCode.LeftArrow) || Input.GetKeyDown(KeyCode.LeftArrow))</span><br><span class="line">        &#123;</span><br><span class="line">            _context.ReplaceLeftArrowState(EArrowState.Down);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (Input.GetKeyUp(KeyCode.LeftArrow))</span><br><span class="line">        &#123;</span><br><span class="line">            _context.ReplaceLeftArrowState(EArrowState.Up);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            _context.ReplaceLeftArrowState(EArrowState.None);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Input.GetKey(KeyCode.RightArrow) || Input.GetKeyDown(KeyCode.RightArrow))</span><br><span class="line">        &#123;</span><br><span class="line">            _context.ReplaceRightArrowState(EArrowState.Down);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (Input.GetKeyUp(KeyCode.RightArrow))</span><br><span class="line">        &#123;</span><br><span class="line">            _context.ReplaceRightArrowState(EArrowState.Up);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            _context.ReplaceRightArrowState(EArrowState.None);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="MovementSystem-cs-ReactiveSystem"><a href="#MovementSystem-cs-ReactiveSystem" class="headerlink" title="MovementSystem.cs        ReactiveSystem"></a>MovementSystem.cs        ReactiveSystem</h2><p>当左右按键按下时需要移动Entity。那么需要一个速度组件。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Entitas;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MoveSpeedComponent</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Game</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MoveSpeedComponent</span> : <span class="title">IComponent</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> <span class="keyword">value</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在Entity有了MoveSpeedComponent组件之后需要根据每帧的间隔时间和速度确定移动距离，并改变Entity的PositionComponent最后交由RenderPositionSystem刷新位置。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Entitas;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MovementSystem</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MovementSystem</span> : <span class="title">ReactiveSystem</span>&lt;<span class="title">GameEntity</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MovementSystem</span>(<span class="params">Contexts contexts</span>) : <span class="title">base</span>(<span class="params">contexts.game</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Execute</span>(<span class="params">List&lt;GameEntity&gt; entities</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> entities)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">float</span> interval = Time.deltaTime;</span><br><span class="line">            <span class="comment">//移动距离</span></span><br><span class="line">            <span class="built_in">float</span> moveInterval = interval * item.moveSpeed.<span class="keyword">value</span>;</span><br><span class="line">            Vector2 position = item.position.<span class="keyword">value</span>;</span><br><span class="line">            <span class="comment">//移动完成后的坐标信息</span></span><br><span class="line">            position.x += moveInterval;</span><br><span class="line">            item.ReplacePosition(position);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">Filter</span>(<span class="params">GameEntity entity</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> entity.hasMoveSpeed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> ICollector&lt;GameEntity&gt; <span class="title">GetTrigger</span>(<span class="params">IContext&lt;GameEntity&gt; context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> context.CreateCollector(GameMatcher.MoveSpeed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="CommandMoveSystem-cs-ReactiveSystem"><a href="#CommandMoveSystem-cs-ReactiveSystem" class="headerlink" title="CommandMoveSystem.cs            ReactiveSystem"></a>CommandMoveSystem.cs            ReactiveSystem</h2><p>通过InputDeviceSystem.cs可以检测到左右按键按下松开状态了，但是Game Context中的Entity还并没有速度值所以现在还没有办法移动，所以需要在LeftArrowStateComponent，RightArrowStateComponent两个组件发生变化时改变GameEntity的速度值。<br>这里我们简单处理，如果向左移动速度值设置成负值，向右移动速度值设置成正值，同时设置物体的DirectionComponent组件。<br>如果左右两个按键都没有按下时把小熊的MoveSpeedComponent移除小熊就会停下，并把DirectionComponent设置成站立状态。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Entitas;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> CommandMoveSystem</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CommandMoveSystem</span> : <span class="title">ReactiveSystem</span>&lt;<span class="title">InputEntity</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">readonly</span> IGroup&lt;GameEntity&gt; moveEntitys;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommandMoveSystem</span>(<span class="params">Contexts contexts</span>) : <span class="title">base</span>(<span class="params">contexts.input</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//找到</span></span><br><span class="line">        <span class="built_in">int</span>[] allof = &#123; GameComponentsLookup.View, GameComponentsLookup.Direction &#125;;</span><br><span class="line">        moveEntitys = contexts.game.GetGroup(GameMatcher.AllOf(allof));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Execute</span>(<span class="params">List&lt;InputEntity&gt; entities</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> entities)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//左键或右键Up状态</span></span><br><span class="line">            <span class="keyword">if</span> ((item.hasLeftArrowState &amp;&amp; item.leftArrowState.state == EArrowState.Up) ||</span><br><span class="line">                (item.hasRightArrowState &amp;&amp; item.rightArrowState.state == EArrowState.Up))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> moveEntitys)</span><br><span class="line">                &#123;</span><br><span class="line">                    entity.ReplaceDirection(DirectionComponent.EDirection.stand);</span><br><span class="line">                    entity.RemoveMoveSpeed();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (item.hasLeftArrowState &amp;&amp; item.leftArrowState.state == EArrowState.Down)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> moveEntitys)</span><br><span class="line">                &#123;</span><br><span class="line">                    entity.ReplaceDirection(DirectionComponent.EDirection.left);</span><br><span class="line">                    entity.ReplaceMoveSpeed(<span class="number">-3.0f</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (item.hasRightArrowState &amp;&amp; item.rightArrowState.state == EArrowState.Down)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> moveEntitys)</span><br><span class="line">                &#123;</span><br><span class="line">                    entity.ReplaceDirection(DirectionComponent.EDirection.right);</span><br><span class="line">                    entity.ReplaceMoveSpeed(<span class="number">3.0f</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">Filter</span>(<span class="params">InputEntity entity</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> (entity.hasLeftArrowState &amp;&amp; entity.leftArrowState.state != EArrowState.None)</span><br><span class="line">            || (entity.hasRightArrowState &amp;&amp; entity.rightArrowState.state != EArrowState.None);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> ICollector&lt;InputEntity&gt; <span class="title">GetTrigger</span>(<span class="params">IContext&lt;InputEntity&gt; context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span>[] anyof = &#123; InputComponentsLookup.LeftArrowState, InputComponentsLookup.RightArrowState &#125;;</span><br><span class="line">        <span class="keyword">return</span> context.CreateCollector(InputMatcher.AnyOf(anyof));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后还是一样需要将新建的System加到GameSystems中。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Entitas;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameSystems</span> : <span class="title">Feature</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GameSystems</span>(<span class="params">Contexts contexts</span>) : <span class="title">base</span>(<span class="params"><span class="string">&quot;Game Systems&quot;</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* -- Init System -- */</span></span><br><span class="line">        Add(<span class="keyword">new</span> AddViewSystem(contexts));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* -- Execute System -- */</span></span><br><span class="line">        Add(<span class="keyword">new</span> RenderPositionSystem(contexts));</span><br><span class="line">        Add(<span class="keyword">new</span> RenderDirectionSystem(contexts));</span><br><span class="line">        Add(<span class="keyword">new</span> RenderSpriteSystem(contexts));</span><br><span class="line"></span><br><span class="line">        Add(<span class="keyword">new</span> InputDeviceSystem(contexts));</span><br><span class="line">        Add(<span class="keyword">new</span> CommandMoveSystem(contexts));</span><br><span class="line">        Add(<span class="keyword">new</span> MovementSystem(contexts));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在可以回到Unity运行一下，按下左右按键时物体已经可以移动了。<br>现在案例已经基本完成了，只差最后一步在物体移动时实时打印位置了。<br>通过处理移动的过程可以看出Entitas的核心思想是Component只需记录数据或者状态，专门的事交由专门的System处理，Entity只是为了承载Component并无其他作用。</p>
<h1 id="总结：IExecuteSystem-在游戏运行后每帧执行一次，可以在这里处理类似Input等事件。"><a href="#总结：IExecuteSystem-在游戏运行后每帧执行一次，可以在这里处理类似Input等事件。" class="headerlink" title="总结：IExecuteSystem 在游戏运行后每帧执行一次，可以在这里处理类似Input等事件。"></a>总结：IExecuteSystem 在游戏运行后每帧执行一次，可以在这里处理类似Input等事件。</h1><hr>
<h1 id="ICleanupSystem"><a href="#ICleanupSystem" class="headerlink" title="ICleanupSystem"></a>ICleanupSystem</h1><p>这一章开始实现案例最后一个功能，实时打印物体的位置信息。<br>可能你会问打印位置信息和Entitas有什么关系，一句Debug.Log()不就完事了，是的!如果是在Unity环境下是这样一句话就行了，但是Entitas的开发环境是不依赖于Untiy的，这样的好处是如果有服务器和客户端公用一套战斗逻辑的时候，Entitas从客户端移植到服务器就会很方便，但是因为刚才在代码中插入了Debug.Log()导致需要修改源码或者服务器引入UnityEngine.dll。</p>
<h2 id="ICleanupSystem-1"><a href="#ICleanupSystem-1" class="headerlink" title="ICleanupSystem"></a>ICleanupSystem</h2><p>这个系统主要是在每帧的逻辑执行结束之后执行Cleanup()做一些清理工作，是的，这个系统也是每帧执行一次，那么它和IExecuteSystem又有什么区别呢。<br>你可以对照一下MonoBehaviour生命周期中的Update()和LateUpdate()的区别。<br>所以Systems.Execute()调用之后才能调用Systems.Cleanup()方法。或者干脆将Systems.Cleanup()方法放在LateUpdate()中调用。</p>
<h2 id="LogMessageComponent-cs"><a href="#LogMessageComponent-cs" class="headerlink" title="LogMessageComponent.cs"></a>LogMessageComponent.cs</h2><p>首先我们需要一个LogMessageComponent用来记录需要打印的数据信息。</p>
<h2 id="ShowLogMessageSystem-cs-ReactiveSystem"><a href="#ShowLogMessageSystem-cs-ReactiveSystem" class="headerlink" title="ShowLogMessageSystem.cs            ReactiveSystem"></a>ShowLogMessageSystem.cs            ReactiveSystem</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Entitas;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> ShowLogMessageSystem</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ShowLogMessageSystem</span> : <span class="title">ReactiveSystem</span>&lt;<span class="title">GameEntity</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ShowLogMessageSystem</span>(<span class="params">Contexts contexts</span>) : <span class="title">base</span>(<span class="params">contexts.game</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Execute</span>(<span class="params">List&lt;GameEntity&gt; entities</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> entities)</span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(item.logMessage.message);</span><br><span class="line">            <span class="comment">//item.isDestoryLog = true;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">Filter</span>(<span class="params">GameEntity entity</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> entity.hasLogMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> ICollector&lt;GameEntity&gt; <span class="title">GetTrigger</span>(<span class="params">IContext&lt;GameEntity&gt; context</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> context.CreateCollector(GameMatcher.LogMessage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还需要在RenderPositionSystem中刷新GameObject位置的时候创建一个拥有LogMessageComponent的Entity。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RenderPositionSystem</span> : <span class="title">ReactiveSystem</span>&lt;<span class="title">GameEntity</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Execute</span>(<span class="params">List&lt;GameEntity&gt; entities</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> entities)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//为每个符合条件的Entity刷新位置</span></span><br><span class="line">            item.view.gameObject.transform.position = item.position.<span class="keyword">value</span>;</span><br><span class="line">            <span class="comment">//创建一个Entity并添加LogMessageComponeent</span></span><br><span class="line">            _context.CreateEntity().AddLogMessage(<span class="built_in">string</span>.Format(<span class="string">&quot;position = &#123;0&#125;,&#123;1&#125;&quot;</span>,item.position.<span class="keyword">value</span>.x, item.position.<span class="keyword">value</span>.y));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：因为这里创建的GameEntity只有LogMessageComponent，没有ViewComponent, SpriteComponent等所以不会被RenderPositionSystem等其他System处理。<br>最后将ShowLogMessageSystem.cs添加到GameSystems中。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameSystems</span> : <span class="title">Feature</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GameSystems</span>(<span class="params">Contexts contexts</span>) : <span class="title">base</span>(<span class="params"><span class="string">&quot;Game Systems&quot;</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        Add(<span class="keyword">new</span> ShowLogMessageSystem(contexts));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回到Unity编辑器运行一下，可以在控制台看到打印信息了，但是有一个很可怕的情况出现了，随着我们的运行GameEntity越来越多，这些Entity会创建只是包含了我们的输出信息，之后就再也没用了，那么我们需要在信息被输出之后将这个GameEntity清除掉。</p>
<h2 id="DestoryLogMessageSystem-cs-ICleanupSystem"><a href="#DestoryLogMessageSystem-cs-ICleanupSystem" class="headerlink" title="DestoryLogMessageSystem.cs            ICleanupSystem"></a>DestoryLogMessageSystem.cs            ICleanupSystem</h2><p>我们在ShowLogMessageSystem中会输出信息，ShowLogMessageSystem是继承ReactiveSystem，所以可以在ICleanupSystem中清理所有拥有LogMessageComponent的实体，因为ReactiveSystem实现了IExecuteSystem接口的Execute()方法，而前面我们也说过了ICleanupSystem 的执行会晚于IExecuteSystem。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Entitas;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> DestoryLogMessageSystem</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DestoryLogMessageSystem</span> : <span class="title">ICleanupSystem</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">readonly</span> GameContext _context;</span><br><span class="line">    <span class="keyword">readonly</span> IGroup&lt;GameEntity&gt; messageEntity;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DestoryLogMessageSystem</span>(<span class="params">Contexts contexts</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _context = contexts.game;</span><br><span class="line">        messageEntity = _context.GetGroup(GameMatcher.LogMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Cleanup</span>(<span class="params"></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> messageEntity.GetEntities())</span><br><span class="line">        &#123;</span><br><span class="line">            item.Destroy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后再将DestoryLogMessageSystem.cs添加到GameSystem中，并再GameController的LateUpdate()方法中执行Systems的Cleanup()方法</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameController</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">LateUpdate</span>(<span class="params"></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _systems.Cleanup();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="总结：-ICleanupSystem也是每帧执行的系统。不过从逻辑上区分这个system是为了我们在执行完所有的IExecuteSystem之后执行的逻辑所设立的-用来做一些数据的清理的作用-需要重写void-Cleanup-方法-将清理逻辑写在这个方法中。"><a href="#总结：-ICleanupSystem也是每帧执行的系统。不过从逻辑上区分这个system是为了我们在执行完所有的IExecuteSystem之后执行的逻辑所设立的-用来做一些数据的清理的作用-需要重写void-Cleanup-方法-将清理逻辑写在这个方法中。" class="headerlink" title="总结： ICleanupSystem也是每帧执行的系统。不过从逻辑上区分这个system是为了我们在执行完所有的IExecuteSystem之后执行的逻辑所设立的,用来做一些数据的清理的作用.需要重写void Cleanup()方法; 将清理逻辑写在这个方法中。"></a>总结： ICleanupSystem也是每帧执行的系统。不过从逻辑上区分这个system是为了我们在执行完所有的IExecuteSystem之后执行的逻辑所设立的,用来做一些数据的清理的作用.需要重写void Cleanup()方法; 将清理逻辑写在这个方法中。</h1><hr>
<h1 id="ITearDownSystem"><a href="#ITearDownSystem" class="headerlink" title="ITearDownSystem"></a>ITearDownSystem</h1><h2 id="ITearDownSystem-1"><a href="#ITearDownSystem-1" class="headerlink" title="ITearDownSystem"></a>ITearDownSystem</h2><p>ITearDownSystem在程序结束运行时运行一次TearDown()接口，可以在这个接口中执行一些数据保存，断开网络等操作。可以参考MonoBehaviour生命周期中的OnDestroy()。</p>
<h2 id="MyTearDownSystem-cs-ITearDownSystem"><a href="#MyTearDownSystem-cs-ITearDownSystem" class="headerlink" title="MyTearDownSystem.cs            ITearDownSystem"></a>MyTearDownSystem.cs            ITearDownSystem</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Entitas;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> MyTearDownSystem</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyTearDownSystem</span> : <span class="title">ITearDownSystem</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">readonly</span> GameContext _context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyTearDownSystem</span>(<span class="params">Contexts contexts</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _context = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TearDown</span>(<span class="params"></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;Game Over!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将MyTearDownSystem.cs添加到GameSystem中，并再GameController的OnDestroy()方法中执行Systems的TearDown()方法。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">愚人</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://afoolzwt.github.io/2022/02/07/ECS2/">https://afoolzwt.github.io/2022/02/07/ECS2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://afoolzwt.github.io" target="_blank">愚人のblog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Unity/">Unity</a><a class="post-meta__tags" href="/tags/ECS/">ECS</a></div><div class="post_share"><div class="social-share" data-image="/img/cover2.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/02/07/ECS1/"><img class="prev-cover" src="/img/cover2.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">ECS学习笔记（1）</div></div></a></div><div class="next-post pull-right"><a href="/2022/01/25/HQGXLua/"><img class="next-cover" src="/img/cover2.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">XLua项目使用-HQG</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/02/07/ECS3/" title="ECS学习笔记（3）"><img class="cover" src="/img/cover2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-07</div><div class="title">ECS学习笔记（3）</div></div></a></div><div><a href="/2022/02/07/ECS1/" title="ECS学习笔记（1）"><img class="cover" src="/img/cover2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-07</div><div class="title">ECS学习笔记（1）</div></div></a></div><div><a href="/2022/02/25/GameFrameWork%E6%A8%A1%E5%9D%97/" title="Game Framework 模块汇总"><img class="cover" src="/img/cover2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-25</div><div class="title">Game Framework 模块汇总</div></div></a></div><div><a href="/2022/01/25/HQGXLua/" title="XLua项目使用-HQG"><img class="cover" src="/img/cover2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-25</div><div class="title">XLua项目使用-HQG</div></div></a></div><div><a href="/2022/01/25/ILR1/" title="ILRuntime学习笔记(1)"><img class="cover" src="/img/cover2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-25</div><div class="title">ILRuntime学习笔记(1)</div></div></a></div><div><a href="/2022/01/25/ILR2/" title="ILRuntime学习笔记(2)"><img class="cover" src="/img/cover2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-25</div><div class="title">ILRuntime学习笔记(2)</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/headicon.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">愚人</div><div class="author-info__description">为做出理想游戏而不懈努力。</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">55</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">44</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/AFoolZWT"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎来到我的博客</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#IInitializeSystem"><span class="toc-text">IInitializeSystem</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%87%86%E5%A4%87"><span class="toc-text">案例准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAViewComponent-cs"><span class="toc-text">创建ViewComponent.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAAddSystem-cs-IInitializeSystem"><span class="toc-text">创建AddSystem.cs     IInitializeSystem</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%93%E5%B1%95%EF%BC%9AC-%E4%B8%AD%E7%9A%84readonly"><span class="toc-text">拓展：C#中的readonly</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GameSystems-cs"><span class="toc-text">GameSystems.cs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GameController-cs"><span class="toc-text">GameController.cs</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ReactiveSystem%EF%BC%9CEntity%EF%BC%9E"><span class="toc-text">ReactiveSystem＜Entity＞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ReactiveSystem"><span class="toc-text">ReactiveSystem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RenderSpriteSystem-cs-ReactiveSystem"><span class="toc-text">RenderSpriteSystem.cs        ReactiveSystem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RenderPositionSystem-cs-ReactiveSystem"><span class="toc-text">RenderPositionSystem.cs        ReactiveSystem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RenderDirectionSystem-cs-ReactiveSystem"><span class="toc-text">RenderDirectionSystem.cs            ReactiveSystem</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%EF%BC%9A-ReactiveSystem%E5%B0%B1%E6%98%AF%E5%AE%9E%E6%97%B6%E6%94%B6%E9%9B%86%E4%B8%80%E4%BA%9B%E8%87%AA%E5%B7%B1%E6%84%9F%E5%85%B4%E8%B6%A3%E7%9A%84%E7%BB%84%E4%BB%B6%E5%8F%91%E7%94%9F%E5%8F%98%E5%8C%96%E7%9A%84Entity%EF%BC%8C%E5%B9%B6%E6%89%A7%E8%A1%8C%E7%9B%B8%E5%BA%94%E7%9A%84%E9%80%BB%E8%BE%91%E3%80%82"><span class="toc-text">总结： ReactiveSystem就是实时收集一些自己感兴趣的组件发生变化的Entity，并执行相应的逻辑。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IExecuteSystem"><span class="toc-text">IExecuteSystem</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ArrowStateComponent-cs"><span class="toc-text">ArrowStateComponent.cs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InputDeviceSystem-cs-IInitializeSystem-IExecuteSystem"><span class="toc-text">InputDeviceSystem.cs            IInitializeSystem,IExecuteSystem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MovementSystem-cs-ReactiveSystem"><span class="toc-text">MovementSystem.cs        ReactiveSystem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CommandMoveSystem-cs-ReactiveSystem"><span class="toc-text">CommandMoveSystem.cs            ReactiveSystem</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%EF%BC%9AIExecuteSystem-%E5%9C%A8%E6%B8%B8%E6%88%8F%E8%BF%90%E8%A1%8C%E5%90%8E%E6%AF%8F%E5%B8%A7%E6%89%A7%E8%A1%8C%E4%B8%80%E6%AC%A1%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%9C%A8%E8%BF%99%E9%87%8C%E5%A4%84%E7%90%86%E7%B1%BB%E4%BC%BCInput%E7%AD%89%E4%BA%8B%E4%BB%B6%E3%80%82"><span class="toc-text">总结：IExecuteSystem 在游戏运行后每帧执行一次，可以在这里处理类似Input等事件。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ICleanupSystem"><span class="toc-text">ICleanupSystem</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ICleanupSystem-1"><span class="toc-text">ICleanupSystem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LogMessageComponent-cs"><span class="toc-text">LogMessageComponent.cs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ShowLogMessageSystem-cs-ReactiveSystem"><span class="toc-text">ShowLogMessageSystem.cs            ReactiveSystem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DestoryLogMessageSystem-cs-ICleanupSystem"><span class="toc-text">DestoryLogMessageSystem.cs            ICleanupSystem</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%EF%BC%9A-ICleanupSystem%E4%B9%9F%E6%98%AF%E6%AF%8F%E5%B8%A7%E6%89%A7%E8%A1%8C%E7%9A%84%E7%B3%BB%E7%BB%9F%E3%80%82%E4%B8%8D%E8%BF%87%E4%BB%8E%E9%80%BB%E8%BE%91%E4%B8%8A%E5%8C%BA%E5%88%86%E8%BF%99%E4%B8%AAsystem%E6%98%AF%E4%B8%BA%E4%BA%86%E6%88%91%E4%BB%AC%E5%9C%A8%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%89%80%E6%9C%89%E7%9A%84IExecuteSystem%E4%B9%8B%E5%90%8E%E6%89%A7%E8%A1%8C%E7%9A%84%E9%80%BB%E8%BE%91%E6%89%80%E8%AE%BE%E7%AB%8B%E7%9A%84-%E7%94%A8%E6%9D%A5%E5%81%9A%E4%B8%80%E4%BA%9B%E6%95%B0%E6%8D%AE%E7%9A%84%E6%B8%85%E7%90%86%E7%9A%84%E4%BD%9C%E7%94%A8-%E9%9C%80%E8%A6%81%E9%87%8D%E5%86%99void-Cleanup-%E6%96%B9%E6%B3%95-%E5%B0%86%E6%B8%85%E7%90%86%E9%80%BB%E8%BE%91%E5%86%99%E5%9C%A8%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E4%B8%AD%E3%80%82"><span class="toc-text">总结： ICleanupSystem也是每帧执行的系统。不过从逻辑上区分这个system是为了我们在执行完所有的IExecuteSystem之后执行的逻辑所设立的,用来做一些数据的清理的作用.需要重写void Cleanup()方法; 将清理逻辑写在这个方法中。</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ITearDownSystem"><span class="toc-text">ITearDownSystem</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ITearDownSystem-1"><span class="toc-text">ITearDownSystem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MyTearDownSystem-cs-ITearDownSystem"><span class="toc-text">MyTearDownSystem.cs            ITearDownSystem</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/04/17/U3D%E9%AB%98%E7%BA%A7%E7%A8%8B%E5%BA%8F%E7%BC%96%E7%A8%8B/U3D%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B(UGUI%E4%BA%8B%E4%BB%B6%E6%A8%A1%E5%9D%97%E5%89%96%E6%9E%90)/" title="《U3D高级编程》- UGUI事件模块剖析"><img src="/img/books/U3D%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="《U3D高级编程》- UGUI事件模块剖析"/></a><div class="content"><a class="title" href="/2023/04/17/U3D%E9%AB%98%E7%BA%A7%E7%A8%8B%E5%BA%8F%E7%BC%96%E7%A8%8B/U3D%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B(UGUI%E4%BA%8B%E4%BB%B6%E6%A8%A1%E5%9D%97%E5%89%96%E6%9E%90)/" title="《U3D高级编程》- UGUI事件模块剖析">《U3D高级编程》- UGUI事件模块剖析</a><time datetime="2023-04-16T16:00:00.000Z" title="发表于 2023-04-17 00:00:00">2023-04-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/17/U3D%E9%AB%98%E7%BA%A7%E7%A8%8B%E5%BA%8F%E7%BC%96%E7%A8%8B/U3D%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B(UGUI%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90)/" title="《U3D高级编程》- UGUI核心源码剖析"><img src="/img/books/U3D%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="《U3D高级编程》- UGUI核心源码剖析"/></a><div class="content"><a class="title" href="/2023/04/17/U3D%E9%AB%98%E7%BA%A7%E7%A8%8B%E5%BA%8F%E7%BC%96%E7%A8%8B/U3D%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B(UGUI%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90)/" title="《U3D高级编程》- UGUI核心源码剖析">《U3D高级编程》- UGUI核心源码剖析</a><time datetime="2023-04-16T16:00:00.000Z" title="发表于 2023-04-17 00:00:00">2023-04-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/17/U3D%E9%AB%98%E7%BA%A7%E7%A8%8B%E5%BA%8F%E7%BC%96%E7%A8%8B/U3D%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B(Unity3D%E4%B8%ADC#%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86)%20/" title="《U3D高级编程》- Unity3D中C#的底层原理"><img src="/img/books/U3D%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="《U3D高级编程》- Unity3D中C#的底层原理"/></a><div class="content"><a class="title" href="/2023/04/17/U3D%E9%AB%98%E7%BA%A7%E7%A8%8B%E5%BA%8F%E7%BC%96%E7%A8%8B/U3D%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B(Unity3D%E4%B8%ADC#%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86)%20/" title="《U3D高级编程》- Unity3D中C#的底层原理">《U3D高级编程》- Unity3D中C#的底层原理</a><time datetime="2023-04-16T16:00:00.000Z" title="发表于 2023-04-17 00:00:00">2023-04-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/17/U3D%E9%AB%98%E7%BA%A7%E7%A8%8B%E5%BA%8F%E7%BC%96%E7%A8%8B/U3D%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B(%E6%95%B0%E6%8D%AE%E8%A1%A8%E7%9A%84%E7%A7%8D%E7%B1%BB)%20/" title="《U3D高级编程》- 数据表的种类"><img src="/img/books/U3D%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="《U3D高级编程》- 数据表的种类"/></a><div class="content"><a class="title" href="/2023/04/17/U3D%E9%AB%98%E7%BA%A7%E7%A8%8B%E5%BA%8F%E7%BC%96%E7%A8%8B/U3D%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B(%E6%95%B0%E6%8D%AE%E8%A1%A8%E7%9A%84%E7%A7%8D%E7%B1%BB)%20/" title="《U3D高级编程》- 数据表的种类">《U3D高级编程》- 数据表的种类</a><time datetime="2023-04-16T16:00:00.000Z" title="发表于 2023-04-17 00:00:00">2023-04-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/04/17/U3D%E9%AB%98%E7%BA%A7%E7%A8%8B%E5%BA%8F%E7%BC%96%E7%A8%8B/U3D%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B(%E7%94%A8%E6%88%B7%E7%95%8C%E9%9D%A2%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%AF%94%E8%BE%83)%20/" title="《U3D高级编程》- 用户界面系统的比较"><img src="/img/books/U3D%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="《U3D高级编程》- 用户界面系统的比较"/></a><div class="content"><a class="title" href="/2023/04/17/U3D%E9%AB%98%E7%BA%A7%E7%A8%8B%E5%BA%8F%E7%BC%96%E7%A8%8B/U3D%E9%AB%98%E7%BA%A7%E7%BC%96%E7%A8%8B(%E7%94%A8%E6%88%B7%E7%95%8C%E9%9D%A2%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%AF%94%E8%BE%83)%20/" title="《U3D高级编程》- 用户界面系统的比较">《U3D高级编程》- 用户界面系统的比较</a><time datetime="2023-04-16T16:00:00.000Z" title="发表于 2023-04-17 00:00:00">2023-04-17</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 愚人</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '2L5WFGGosqmMsQkoWAORAVz8-gzGzoHsz',
      appKey: 'Aw2OnjzWeYL9LYdqwpwuVuXI',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>